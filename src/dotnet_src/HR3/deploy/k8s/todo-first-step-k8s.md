Окей, давай зафиксируем процесс как чек-лист — без YAML и кода.

# Шаги деплоя приложения в k3s с SSL (Let’s Encrypt)

## 1) Подготовка и предпосылки

* Домены: определён FQDN (например, `app.example.com`).
* DNS: A/AAAA-записи указывают на публичный IP балансировщика/ноды кластера.
* Сеть/фаервол: порты 80 (HTTP) и 443 (HTTPS) открыты до ingress-контроллера.
* Ingress-контроллер: в k3s по умолчанию Traefik. Реши, **кто** будет получать сертификат:

    * **cert-manager** (рекомендуется) — централизованно для кластера.
    * или встроенный ACME у Traefik — тогда **не** ставим cert-manager, чтобы не конфликтовать.
* Регистри: если образы приватные — есть учётка/секрет для pull из вашего Nexus.

## 2) Организация пространства

* Создать **namespace** для приложения (например, `prod-<app>`).
* (Опционально) Задать **ResourceQuota/LimitRange**, **NetworkPolicy**, секреты для приватного регистри.

## 3) Установка cert-manager (если выбран он)

* Разворачиваем cert-manager в своём неймспейсе (обычно `cert-manager`).
* Проверяем: контроллер, webhook, cainjector — все поды в Ready.
* Важно: убедиться, что ACME у Traefik **выключен**, если используем cert-manager.

## 4) Выбор способа валидации ACME

* **HTTP-01** (проще): Let’s Encrypt проверяет через `http://<домен>/.well-known/acme-challenge/*`.

    * Требования: порт 80 доступен извне, маршрут до вашего ingress.
* **DNS-01** (для wildcard/внутренних): нужен доступ к DNS-провайдеру для создания TXT-записей.

## 5) Настройка Issuer’ов

* Создаём **ClusterIssuer** (на весь кластер) или **Issuer** (локально в ns).
* Два варианта:

    * **Staging** (для первичной проверки, без лимитов и с тестовым сертификатом).
    * **Production** (боевой — после успешной проверки).
* Указываем email администратора ACME и выбранный тип challenge (HTTP-01 или DNS-01).

## 6) Структура Helm-чарта приложения

Чарт должен описывать:

* **Deployment** (образ, теги, ресурсы, probes, переменные окружения).
* **Service** (обычно `ClusterIP`, порт приложения).
* **Ingress**:

    * host = ваш домен.
    * привязка к нужному `ingressClassName` (обычно `traefik`).
    * аннотации для cert-manager: какой (Cluster)Issuer использовать.
    * правило редиректа 80 → 443 (через middleware/аннотации или отдельный ingress для HTTP).
    * секция TLS с `secretName` (cert-manager создаст и наполнит его автоматически).
* (Опционально) **ConfigMap/Secret** для конфигов и чувствительных данных.
* (Опционально) **imagePullSecrets** для приватного регистри.

## 7) Порядок запуска

1. Неймспейс готов.
2. cert-manager установлен и здоров.
3. Создан (Cluster)Issuer **Staging**.
4. Деплоим приложение (Helm install/upgrade) с Ingress, указывая Staging-Issuer.
5. Проверяем выпуск: статус Certificate/Order/Challenge у cert-manager и события у Ingress/Traefik.
6. По успеху меняем Issuer на **Production** и применяем.
7. Валидируем HTTPS: домен открывается, цепочка сертификата корректная.

## 8) Важные проверки

* **DNS** действительно указывает на ingress-IP.
* Порт **80** доступен (для HTTP-01). Никакие глобальные редиректы/фаерволы не ломают `/.well-known/acme-challenge`.
* В кластере **только один** механизм ACME (либо cert-manager, либо Traefik-ACME).
* В Ingress верно указан `ingressClassName` и нужные аннотации.
* Для приватных образов — `imagePullSecrets` привязан к ServiceAccount/Deployment.

## 9) Эксплуатация и обновления

* **Автопродление**: cert-manager сам продлевает сертификаты (обычно за 30 дней до истечения).
* **Обновления приложения**: меняем тег образа и делаем `helm upgrade`; настроены стратегии rolling update и probes.
* **Мониторинг**: логи cert-manager и ingress-контроллера; оповещения по событиям сертификатов.
* **Безопасность TLS**: включаем HSTS (с осторожностью), минимальные версии TLS, рекомендованные шифросьюты.
* **Резерв**: при необходимости можно загрузить собственный купленный сертификат в Secret и сослаться на него в Ingress (без ACME).

## 10) Расширенные кейсы

* **Несколько доменов / wildcard**: используем DNS-01 и ClusterIssuer с доступом к DNS-провайдеру.
* **Внутренние домены без внешнего DNS**: выпускаем внутренний сертификат от собственной CA или используем self-signed (не для публичного интернета).
* **Zero-downtime для ingress-смен**: держим staging и production issuers, переключаем аннотацией, следим за готовностью нового секрета.

---

Если хочешь, следующим шагом могу собрать для тебя «скелет» Helm-чарта и список конкретных значений `values`, чтобы осталось только подставить домен и образ.
